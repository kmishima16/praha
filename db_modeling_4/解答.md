# データベースモデリング4

> リマインダーアプリ、Penpenのデータベースを設計して、スケッチを作成してください。
> 以下の機能を備えているものとします

>- リマインダー
>    - Slackに登録している他のユーザ（複数可）宛にリマインダーを設定できる
>    - リマインダーには送信相手、文面、頻度を指定可能
>    - 1時間ごとにバッチが動き、配信が必要なリマインダーを指定されたSlackユーザに配信する
>- リマインダーの周期
>    - 設定可能な周期は、現時点では以下の4種類（もしかすると今後増えるかもしれませんが、未定です！）
>        - 毎日
>        - X日おき
>        - 毎週X曜日
>        - 毎月X日

## ER図

![ER図](https://github.com/kmishima16/praha/blob/feature/db_modeling_4/png/ER%E5%9B%B3.png)

### テーブル定義

#### ユーザテーブル(users)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|主キー|
|user_name|varchar|slackのユーザ名|
|created_at|timestamp|作成時刻|

#### リマインダーテーブル(reminders)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|主キー|
|reminder_id|int|登録ユーザのid|
|sender_id|int|リマインド先ユーザのid|
|message|varchar|リマインド文章|
|cycle_message|varchar|リマインド周期の文字列(every 3 hours, every 1 daysなど)|
|created_at|timestamp|作成時刻|

#### 実行予定のリマインダーテーブル(scheduled_reminders)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|リマインダーテーブルのid|
|scheduled_at|timestamp|リマインド時刻|

#### 完了済みのリマインダーテーブル(completed_reminders)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|リマインダーテーブルのid|
|created_at|timestamp|作成時刻|

## クエリ

### リマインド登録された時

- `/penpen @kmishima コードレビューお願いします every 1 days`などのメッセージが届く
- リマインド登録者のid, リマインド送信対象者のidを`users`にinsert（未登録であれば）
- `reminders`にユーザid,リマインド文章,リマインド周期を用意してinsert
- `リマインド周期`から、次回リマインド時刻を用意して、`scheduled_reminders`にinsert

### 1時間ごとのバッチ処理

- `scheduled_reminders`を参照して、送信時刻を満たしたリマインダーidを取得する
- `reminders`からリマインド文章、送信先アカウントを取得してリマインドする
- `リマインド周期`から次回のリマインド時刻を用意して、`scheduled_reminders`をupdate

### リマインド済みになった場合

- 完了対象のidを取得する
- `scheduled_reminders`から対象idのレコードをdelete
- `completed_reminders`に対象idのレコードをinsert

## 周期の登録方法について

周期マスタを作成して、`type=1, day=1`なら毎月1日にリマインド、`type=2 day=3`なら毎週水曜日、といった風にカラムの組み合わせで周期を設定する方法があるが、`SQLアンチパターン`によるとEAV（Entity-Attribute-Value）というアンチパターンに含まれている。

デメリットとしては
- どんな列の組み合わせや固有の項目が存在するかがテーブル上からだと分からない
- １つの列に複数の意味合いの値が含まれるのでWHERE句のクエリが作りにくい

書籍内で解決方法としては4つのやり方が示されており、
1. シングルテーブル継承
2. 具象テーブル継承
3. クラステーブル継承
4. 半構造化データ

今回の`reminders`テーブルの`cycle_message`は半構造化データに該当する。

一つの列にパースしやすいjsonやxml文字列を格納することで、動的なパラメータに対応させることが可能らしい。

1~3の解決方法は、パターンごとにテーブルを別途作成するやり方のようで、パターンごとに固有カラムが出現する場合に有効なデータベース設計となるらしい。

（`月x日`,`週x曜日`,`x日おき`など、今回のリマインダーアプリだと固有カラムはほとんど出現しないためそれぞれテーブルを作るやり方はマッチしなさそう）

[参考 - Qiitta](https://qiita.com/tacoman/items/e3dd88f7709c2704758f)