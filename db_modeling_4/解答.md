# データベースモデリング4

> リマインダーアプリ、Penpenのデータベースを設計して、スケッチを作成してください。
> 以下の機能を備えているものとします

>- リマインダー
>    - Slackに登録している他のユーザ（複数可）宛にリマインダーを設定できる
>    - リマインダーには送信相手、文面、頻度を指定可能
>    - 1時間ごとにバッチが動き、配信が必要なリマインダーを指定されたSlackユーザに配信する
>- リマインダーの周期
>    - 設定可能な周期は、現時点では以下の4種類（もしかすると今後増えるかもしれませんが、未定です！）
>        - 毎日
>        - X日おき
>        - 毎週X曜日
>        - 毎月X日

## ER図

![ER図](https://github.com/kmishima16/praha/blob/feature/db_modeling_4/png/ER%E5%9B%B3.png)

### テーブル定義

#### ユーザテーブル(users)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|主キー|
|account_name|varchar|slackのユーザ名|
|created_at|timestamp|作成時刻|

#### リマインダーテーブル(reminders)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|主キー|
|reminder_id|int|登録ユーザのid|
|sender_id|int|リマインド先ユーザのid|
|message|varchar|リマインド文章|
|cycle_message|varchar|リマインド周期の文字列(every 3 hours, every 1 daysなど)|
|created_at|timestamp|作成時刻|

#### 実行予定のリマインダーテーブル(scheduled_reminders)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|リマインダーテーブルのid|
|scheduled_at|timestamp|リマインド時刻|

#### 完了済みのリマインダーテーブル(completed_reminders)

| カラム名   | データ型  | 説明     |
| ---------- | --------- | -------- |
|id|int|リマインダーテーブルのid|
|created_at|timestamp|作成時刻|

## クエリ

### 1. リマインド登録された時

#### 処理の流れ

1. `/penpen @kmishima コードレビューお願いします every 1 days`などのメッセージが届く
2. リマインド登録者のid, リマインド送信対象者のidを`users`にinsert（未登録であれば）
3. `reminders`にユーザid,リマインド文章,リマインド周期を用意してinsert
4. `リマインド周期`から、次回リマインド時刻を用意して、`scheduled_reminders`にinsert

#### SQL

`kmishima`さんが`penpen`さんにコードレビュー依頼をリマインド登録(1日おき)した場合の処理

```sql
-- リマインダーが登録された場合の処理
SET @register_user_name = 'kmishima';
SET @send_user_name = 'penpen';

-- 1. usersテーブルの挿入
INSERT INTO users (account_name) 
VALUES (@register_user_name);

INSERT INTO users (account_name) 
VALUES (@send_user_name);

-- 2. remindersテーブルの挿入
INSERT INTO reminders (reminder_id, sender_id, message, cycle_message)
SELECT u1.id, u2.id, 'コードレビューお願いします', 'every 1 days'
FROM users u1, users u2
WHERE u1.account_name = @register_user_name AND u2.account_name = @send_user_name;

-- 3. scheduled_remindersテーブルの挿入
INSERT INTO scheduled_reminders (id, scheduled_at)
SELECT r.id, NOW() + INTERVAL 1 DAY
FROM reminders r
WHERE r.reminder_id = (SELECT id FROM users WHERE account_name = @register_user_name);
```

#### 実行結果

`users`、`reminders`、`scheduled_reminders`テーブルそれぞれにレコードが挿入されていることを確認した。

![alt text](https://github.com/kmishima16/praha/blob/feature/db_modeling_4/png/query1.png)

### 2. 1時間ごとのバッチ処理

#### 処理の流れ

1. `scheduled_reminders`を参照して、送信時刻を満たしたリマインダーidを取得する
2. `reminders`からリマインド文章、送信先アカウントを取得してリマインドする
3. `リマインド周期`から次回のリマインド時刻を用意して、`scheduled_reminders`をupdate

#### SQL

現在時刻からリマインド対象の`reminder.id`とリマインド文章、送信先ユーザ名を取得する。

最後に次回リマインド時刻を更新して実行終了する。

```sql
-- リマインダーを送信する場合の処理
SET @scheduled_remind_id = NULL;

-- 1. scheduled_remindersからリマインダー対象のid取得
SELECT id INTO @scheduled_remind_id
FROM scheduled_reminders 
WHERE scheduled_at <= NOW();

-- 2. remindersからリマインド文と送信先ユーザ名を取得
SELECT r.message AS `リマインド文章`, u.account_name AS `送信先ユーザ名`
FROM reminders r
JOIN users u ON r.reminder_id = u.id
WHERE r.id = @scheduled_remind_id;

-- 3. 次回リマインダー日付を再登録
UPDATE scheduled_reminders 
SET scheduled_at = NOW() + INTERVAL 1 DAY 
WHERE id = @scheduled_remind_id;
```

#### 実行結果

現在時刻から実行予定の`scheduled_reminders.id`を取得し、`reminders`とJOINすることでリマインド文章、送信先ユーザ名が取得できた。

その後次回リマインド予定時刻が１日後に更新されていることも確認した(下のスクショには入っていませんが、、)。

![alt text](https://github.com/kmishima16/praha/blob/feature/db_modeling_4/png/query2.png)

### 3. リマインド完了時

#### 処理の流れ

- 完了対象のidを取得する
- `scheduled_reminders`から対象idのレコードをdelete
- `completed_reminders`に対象idのレコードをinsert

#### SQL

完了した`remind.id`について、`scheduled_reminders`からDELETEし、`completed_reminders`にINSERTする。

```sql
-- リマインダーが完了した場合の処理
SET @completed_remind_id = 1;

-- 1. scheduled_remindersから対象idを削除
DELETE FROM scheduled_reminders WHERE id = @completed_remind_id;

-- 2. completed_remindersに対象idを登録
INSERT INTO completed_reminders (id, created_at)
VALUES (@completed_remind_id, NOW());
```

#### 実行結果

`deleter_reminders`, `completed_reminder`テーブルが更新されていることを確認した。

![alt text](https://github.com/kmishima16/praha/blob/feature/db_modeling_4/png/query3.png)

## 周期の登録方法について

周期マスタを作成して、`type=1, day=1`なら毎月1日にリマインド、`type=2 day=3`なら毎週水曜日、といった風にカラムの組み合わせで周期を設定する方法があるが、`SQLアンチパターン`によるとEAV（Entity-Attribute-Value）というアンチパターンに含まれている。

デメリットとしては

- どんな列の組み合わせや固有の項目が存在するかがテーブル上からだと分からない
- １つの列に複数の意味合いの値が含まれるのでWHERE句のクエリが作りにくい

書籍内で解決方法としては4つのやり方が示されており、

1. シングルテーブル継承
2. 具象テーブル継承
3. クラステーブル継承
4. 半構造化データ

今回は`4.半構造化データ`を採用し、周期を指定する文字列として`reminders`テーブルに`cycle_message`というカラムを用意している。

`4.半構造化データ`とは、一つの列にパースしやすいjsonやxml文字列などを格納することで、動的なパラメータを１つのカラムに対応させることが可能なやり方らしい。

また、1~3の解決方法は、パターンごとにテーブルを別途作成するやり方のようで、パターンごとに固有カラムが出現する場合に有効なデータベース設計となるらしい。

（`月x日`,`週x曜日`,`x日おき`など、今回のリマインダーアプリだと固有カラムはほとんど出現しないためそれぞれテーブルを作るやり方はマッチしなさそう）

[参考 - Qitta](https://qiita.com/tacoman/items/e3dd88f7709c2704758f)
