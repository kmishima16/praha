---
id: 20250120T12411450
aliases: 
tags:
  - review
created: 2025-01-20T12:41:14
updated: 2025-01-20T12:41:14
sr-due: 2025-01-23
sr-interval: 3
sr-ease: 250
---
# 課題1

以下の質問に回答してください

## 課題1-1

「ログインしているユーザしか投稿できない」機能を備えた掲示板サービスがあるとしましょう。例えば以下のようなコードでアクセスを制御しているとします。

```jsx
if (user.isLoggedIn) {
  // 投稿できる
} else {
  // 投稿できない
}
```

このようなアクセス制御ロジックはオニオンアーキテクチャのどの層に実装するべきでしょうか？（アプリケーション（ユースケース）層、ドメイン層、インフラ層など・・・）

<aside>
💡 ヒント：絶対的な正解は無いため意見が割れると思います

</aside>

### 課題1-2

上記のケースではuserオブジェクトにisLoggedInという属性が付与されています。フロントエンドから送られてきたtokenなどを見て、isLoggedInをtrueにするコードがどこかにあるはずです。例えば以下のような疑似コードです。

```jsx
const token = req.token
const isValidToken = firebaseService.validateToken(token)
const user = new User(isValidToken) // isLoggedInがtrueになるようなuserが作成されるイメージ
```

このようなロジックはオニオンアーキテクチャで言うところの、どの層に実装するべきでしょうか？

### 課題1-3

複数の集約をまたいで整合性を担保したいケースを考えてみましょう。

「タスク」と「活動レポート」二つの集約の整合性を保つ必要があるケースを想定してみます。例えば「タスク」と「活動レポート」の集約があり、タスクを作成したら必ず「タスクを作成しました」と活動レポートを作成しなければいけないとします（[こちらのブログから拝借](https://little-hands.hatenablog.com/entry/2021/03/08/aggregation)）。

どのように実装すれば、複数集約の整合性が担保されると思いますか？

<aside>
💡 ヒント：「元の記事では[複数の集約をトランザクションで横断する方法](https://little-hands.hatenablog.com/entry/2021/03/08/aggregation)」を紹介していますが、「[そもそも複数の集約を強い整合性で担保するのは違和感がある](https://blog.j5ik2o.me/entry/2021/03/09/231332)」と指摘する記事もあります。

それぞれの主張を理解しつつ、ペアで結論を出してみましょう！

</aside>

### 課題1-4

ブログを投稿できるWEBサービスで、Userエンティティに「name」や「avatarImage」など、マイページで表示される情報がプロパティとして定義されている状態を想定してください。

上記のUserエンティティに「emailAddress」や「firebaseUserId」など、認証に関わるような情報を格納するPRが提出されました。これらの情報はドメインロジックとして使うものではなく、純粋に認証のためだけに使われるプロパティです。

果たしてUserエンティティに上記のようなプロパティを増やすことに問題はないのでしょうか？ペアで議論してみてください。

<aside>
💡

ヒント：「認証コンテキスト」「アクセスコンテキスト」「DDD 認証」などのワードで検索してみると理解が深まるかもしれません

</aside>

### 課題1-5

ブログを投稿できるWEBサービスで、ブログの文字数が上限の1000文字を超えたらエラーが生じるようにしたいと考えました。とあるエンジニアが以下のようなコードを提出しました。

```jsx
class Post {
  constructor(text) {
    if (text.length > 1000) {
      throw new Error('blog post too long!')
    }
    this.text = text
  }
}
```

文字数の上限を超えた際にエラーをthrowすることに関して、どのような問題が起き得ると思いますか？

<aside>
💡

food for thought 1：エラーをthrowする以外に、どのような設計パターンが考えられるでしょうか？例えばGo言語であれば、戻り値の第2引数にエラー型のオブジェクトを返すような設計がよく見られます。

</aside>

<aside>
💡 food for thought 2：関数型プログラミングの世界には「モナド」と呼ばれる概念があります。これを活用する方法はないでしょうか？「Result型」などのワードで検索してみても良いかもしれません

</aside>

<aside>
💡 food for thought 3: 「検査例外」「非検査例外」などのワードで検索してみると良いかもしれません

</aside>


